<html>
    <head>
        <link rel="stylesheet" href="adminPanelStyle.css">
        <meta charset="utf-8">
        <body>
            <div class='pageWrapper'>

                <div class='actionButtonsContainer'>
                    <h1>Actions</h1>
                    <div class='buttonsWrapper'>
                        <button class='actionButton' id='scoreboard'>Add <br/> Scoreboard</button>
                        <button class='actionButton' id='statistics'>Add <br/> Statistics</button>
                        <button class='actionButton' id='newGame'>Add <br/> Next Game</button>

                    </div>

                </div>
                <div class='adminPanelContainer' id='adminPanelContainer'>
                    <div class='scoreboardContainer' id='scoreboardContainer'>

                    </div>
                    <div class='gamesPanelContainer'>
                        <div class='gamesPanel' id='gamesPanelContainer'>
                            
                        </div>
                    </div>

                </div>
            </div>
            <script src='./addNewGameScript.js'></script>
            <script src='./addScoreboard.js'></script>
            <script src='./overflowDetector.js'></script>
            <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
            <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
            <script>
            let elementCounter = -1
            $(document).ready()
            {
                let currentLeft = undefined
                let currentBottom = undefined
                $('#newGame').on('click',()=>{
                    elementCounter+=1
                    const newElement = document.createElement('div'); // this line here creates the div element
                    newElement.draggable=true // this line here makes the div element draggable
                    newElement.className='individualGamePanel'+` ${elementCounter}`; // this line gives the div element a className
                    newElement.id='individualGamePanel'; // this line gives the div element an ID
                    newElement.style.position = 'relative' // this line gives the div element the position attributes of relative
                    const newElementGrid = document.querySelector('.gamesPanel'); // this line here selectes the games panel that I'll use to append the newly created element to
                    newElementGrid.appendChild(newElement); // this line appends the div to the gamesPanel
                    $('.individualGamePanel').draggable({ // here I use JQUERY to impl;ement the dragging of the elements
                        containment: '.adminPanelContainer', // this line permits the movement of the dragged elements outside of the admin panel
                        create: function()
                        {
                            let offset = $(this).offset()
                            let x_pos = offset.left
                            let y_pos = offset.top
                            let classCurrentWidget = $(this).attr('class')
                            let widgetNumber = classCurrentWidget.split(' ')[1]
                            let width = $(this).width()
                            let height = $(this).height()   
                            let xy_data={
                                id:widgetNumber,
                                x:x_pos,
                                y:y_pos
                            }         
                            let stringified = JSON.stringify(xy_data)
                            localStorage.setItem('XY_DATA', stringified)          
                            let rect1 = $(this).offset()

                            $('.gamesPanel').children('div').each(function () {
                                if(widgetNumber!=$(this).attr('class').split(' ')[1])
                                {
                                    let rect2 = $(this).offset()
                                    let x_overlap = Math.max(0, Math.min(rect1.left+$(this).width(), rect2.left+$(this).width()) - Math.max(rect1.left, rect2.left));
                                    let y_overlap = Math.max(0, Math.min(rect1.top+$(this).height(), rect2.top+$(this).height()) - Math.max(rect1.top, rect2.top));
                                    let overlapArea = x_overlap*y_overlap
                                    if(overlapArea>0)
                                    {
                                        $(this).insertAfter($('.'+classCurrentWidget.split(' ')[1]))
                                    }
                                }
                            })
                        },
                        drag: function()
                        {
                        
                            // here I am updating the data, that is sent to the JS file, which in turn changes the data for the respective gamepanel 
                            
                            let offset = $(this).offset()
                            let x_pos = offset.left
                            let height = $(this).height()
                            let width =$(this).width()

                            let y_pos = offset.top
                            let classCurrentWidget = $(this).attr('class')
                            let widgetNumber = classCurrentWidget.split(' ')[1]
                            let xy_data={
                                id: widgetNumber,
                                x:x_pos,
                                y:y_pos
                            }         

                            let rect1 = $(this).offset()

                            let stringified = JSON.stringify(xy_data)
                            localStorage.setItem('XY_DATA_UPDATED', stringified) 
                            let xy_data_updated = localStorage.getItem('UPDATED_XY_DATA')
                            
                            $('.gamesPanel').children('div').each(function () {
                                if(widgetNumber != $(this).attr('class').split(' ')[1])
                                {
                                    let rect2 = $(this).offset()
                                    x_overlap = Math.max(0, Math.min(rect1.left+$(this).width(), rect2.left+$(this).width()) - Math.max(rect1.left, rect2.left));
                                    y_overlap = Math.max(0, Math.min(rect1.top+$(this).height(), rect2.top+$(this).height()) - Math.max(rect1.top, rect2.top));
                                    overlapArea = x_overlap*y_overlap
                                    if(overlapArea>0)
                                    {
                                        alert('ERROR! You cannot put this widget here !')
                                        $('.'+classCurrentWidget.split(' ')[1]).draggable({
                                            revert: true
                                        })
                                    }
                                    else
                                    {
                                        $('.'+classCurrentWidget.split(' ')[1]).draggable({
                                            revert: false
                                        })
                                    }
                                }
                            });
                           

                        }
                        
                    })
                })
                $('#scoreboard').on('click', ()=>{
                    $(`.scoreboardPanel`).draggable({
                        containment: '.adminPanelContainer',
                        create: function()
                        {
                            let offset = $(this).offset()
                            let x_pos_rectangle_one = offset.left
                            let y_pos_rectangle_one = offset.top
                            let rect1 = $(this).offset()
                            let firstRectangleId = $(this).attr('id')
                            $('.scoreboardContainer').children('div').each(function () {
                                let secondRectangleId = $(this).attr('id')
                                if(firstRectangleId!=secondRectangleId)
                                {
                                    let rect2 = $(this).offset()
                                    let x_overlap = Math.max(0, Math.min(rect1.left+$(this).width(), rect2.left+$(this).width()) - Math.max(rect1.left, rect2.left));
                                    let y_overlap = Math.max(0, Math.min(rect1.top+$(this).height(), rect2.top+$(this).height()) - Math.max(rect1.top, rect2.top));
                                    let overlapArea = x_overlap*y_overlap
                                    if(overlapArea>0)
                                    {
                                        console.log('overlapping scoreboards on creation!')
                                        $('#'+firstRectangleId).animate({
                                            'top':'55px', 
                                            'left':'560px' 
                                        })
                                        $('#'+secondRectangleId).animate({
                                            'top':'55px', 
                                            'left':'159px' 
                                        })

                                    }
                                }


                            })

                        },
                        start: function()
                        {
                            // console.log('Drag started')
                        },
                        stop: function()
                        {
                            // console.log('Drag ended')
                        },
                        drag: function()
                        {
                            let offset = $(this).offset()
                            let x_pos_rectangle_one = offset.left
                            let y_pos_rectangle_one = offset.top
                            let rect1 = $(this).offset()
                            let firstRectangleId = $(this).attr('id')
                            $('.scoreboardContainer').children('div').each(function () {
                                let secondRectangleId = $(this).attr('id')
                                if(firstRectangleId!=secondRectangleId)
                                {
                                    let rect2 = $(this).offset()
                                    let x_overlap = Math.max(0, Math.min(rect1.left+$(this).width(), rect2.left+$(this).width()) - Math.max(rect1.left, rect2.left));
                                    let y_overlap = Math.max(0, Math.min(rect1.top+$(this).height(), rect2.top+$(this).height()) - Math.max(rect1.top, rect2.top));
                                    let overlapArea = x_overlap*y_overlap
                                    if(overlapArea>0)
                                    {
                                        console.log('collision detected')
                                        $('#'+firstRectangleId).draggable({
                                           revert: true
                                        })
                                    }
                                    else
                                    {
                                        $('#'+firstRectangleId).draggable({
                                           revert: false
                                        })
                                    }


                                                        
                                }


                            })
                        }
                    })
                })
            }
            </script>


        </body>
    </head>
</html>